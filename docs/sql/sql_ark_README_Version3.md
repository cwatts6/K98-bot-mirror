# Ark of Osiris SQL (Task 1A–1C)

This folder contains **source SQL scripts** for the Ark schema.  
Run these against the **ROK_TRACKER** database. The `sql_schema/` folder will be regenerated by your SQL export job.

## Files

- `01_ark_schema_tables.sql`
  - Creates tables, constraints, and indexes required for Ark of Osiris:
    - `ArkAlliances`
    - `ArkMatches`
    - `ArkSignups`
    - `ArkBans`
    - `ArkConfig`
    - `ArkReminderPrefs`
    - `ArkAuditLog`
- `02_ark_schema_verification_procs.sql`
  - Creates `dbo.usp_ArkSchemaVerify` to validate tables/constraints/indexes.
- `03_ark_alliances_seed.sql`
  - Seeds the initial Ark alliances used by the bot (including channel IDs when provided).
- `03_ark_config_seed.sql`
  - Seeds default Ark configuration values (anchor date, cadence, allowed days/times, signup close rule, caps, check-in offset, reminder intervals).
- `04_ark_retention_procs.sql`
  - Creates `dbo.usp_ArkRetentionCleanup` to delete data older than 2 years (configurable).

## Notes on Schema


### ArkAlliances
- **Primary key:** `Alliance` (`nchar(255)`).
- Per‑alliance settings:
  - `RegistrationChannelId`
  - `ConfirmationChannelId`
- Used to control which alliances can create Ark matches.
- Linked to `ArkMatches` via FK.

### ArkMatches
- **Unique:** `(Alliance, ArkWeekendDate)` → one match per alliance per Ark weekend.
- **Status values:** `Scheduled`, `Locked`, `Cancelled`, `Completed`.
- **Indexes:** Optimized for open match lookups.

### ArkSignups
- **Unique:** `(MatchId, GovernorId)` → no duplicate signup per match.
- **SlotType:** `Player` or `Sub`.
- **Status:** `Active`, `Withdrawn`, `Removed`.
- **Roster index:** `(MatchId, Status, SlotType, CreatedAtUtc)`.

### ArkBans
- Supports **Discord user** and/or **Governor** bans.
- Stores `BannedArkWeekends` + `StartArkWeekendDate`.
- `EndArkWeekendDate` is computed as **N*2 weeks** from `StartArkWeekendDate`.

### ArkConfig
- Designed for **single-row** config storage.
- JSON fields store day/time lists and reminder intervals.

### ArkReminderPrefs
- Per-user opt-out flags + optional JSON for interval-specific opt-outs.

### ArkAuditLog
- Stores all Ark actions with optional JSON details.
- `MatchId` has FK to `ArkMatches`.

## Verification
# Ark of Osiris SQL (Task 1A–1C)

This folder contains **source SQL scripts** for the Ark schema.  
Run these against the **ROK_TRACKER** database. The `sql_schema/` folder will be regenerated by your SQL export job.

## Verification

Run:

```sql
EXEC dbo.usp_ArkSchemaVerify;
```

## Retention Cleanup

Run:

```sql
EXEC dbo.usp_ArkRetentionCleanup @RetentionYears = 2;
```

Deletes:
- `ArkSignups` tied to matches older than retention window.
- `ArkAuditLog` rows older than retention window.
- `ArkMatches` older than retention window.
- Revoked bans older than retention window (optional cleanup).
